#include <stdio.h>#include <stdlib.h>#include <string.h>#include <fcntl.h>#include <errno.h>#include <sys/types.h>#include <unistd.h>#include <time.h>#define SIZE 256void errorMsg(char* str);/*This command creates an order for each customer.*/int main(int argc, char* argv[]){	float total = 0.0;	int file, rbytes, wbytes, pid, len, i, storeFilePtr, flag = 1;	char disc[4], confirm[50], *pct, *qty, *temp, *priceNis;	char name[40] = { 0 }, buffer[SIZE] = { 0 }, bufferProd[SIZE] = { 0 }, storeFile[SIZE] = { 0 }, priceNoNis[30] = { 0 }, prod[40] = { 0 }, date[11] = { 0 };	//Using time.h library in order to write the date into the output file.	time_t t = time(NULL);;    struct tm tm = *localtime(&t);	if (argc != 3)		errorMsg("Incorrect amount of args/parms");	//Using GetFlyer command to display the flyer in the terminal.	if ((pid = fork()) == 0)	{		execl("GetFlyer", "GetFlyer", argv[1], NULL);		errorMsg("Error");	}	else if (pid == -1)		errorMsg("Fork failed.");	wait();	//Creating the output file, argv1 = store name, argv2 = customer name.	strcat(name, "Black_Friday/");	strcat(name, argv[1]);	strcat(name,"_Order/");	strcat(name, argv[2]);	strcat(name,".txt");	//Creating the customer file.	if ((file = open(name, O_WRONLY | O_CREAT, 0664)) == -1)		exit(1);	write(file, argv[1], strlen(argv[1]));	write(file, " Order\n", 7);	//Assembling the string in order to access the store_Order folder.	strcat(storeFile,"Black_Friday/");	strcat(storeFile, argv[1]);	strcat(storeFile, ".txt");	if ((storeFilePtr = open(storeFile, O_RDONLY)) == -1)		errorMsg("Open");	if ((rbytes = read (storeFilePtr, &buffer, SIZE)) == -1)		errorMsg("Read");	//Finding the discount and seperating the number.	pct = strchr(buffer, '\n');	for (i = 0; i < 5; i++)	{		if (pct[i + 1] != '%')			disc[i] = pct[i + 1];	}	len = strlen("Insert your order (STOP to finish):\n");	write(0, "Insert your order (STOP to finish):\n", len);	while (strcmp(bufferProd,"STOP\n"))	{		//Reseting the strings in each iteration using memset.		memset(prod, 0, strlen(prod));		memset(priceNoNis, 0, strlen(priceNoNis));		memset(bufferProd, 0, sizeof(bufferProd));		if ((rbytes = read (0, &bufferProd, SIZE)) == -1)			errorMsg("Read");		if (strcmp(bufferProd, "STOP\n"))		{			//A pointer to the last occurrence of the space char in order to save the quantity.			qty = strrchr (bufferProd, ' ');			//Moving the pointer in order to get to the product name and copying it to prod string (without the amount).			strncpy(prod, qty - (strlen(bufferProd) - strlen(qty)), strlen(bufferProd) - strlen(qty));			//Using strstr to find out if the string exists and if it does, saving it to temp ptr in order to access the correct line and work on it.			if ((temp = strstr(buffer, prod)) == NULL)			{				write(0, "Product doesn't exist!\n", strlen("Product doesn't exist!\n"));				continue;			}			//Writing the product and quantity in to the customer file.			write(file, &bufferProd, rbytes);			//Using temp to move the pointer right after the end of the string and then with strchr moving to the price (right after the dots).			priceNis = strchr(temp + strlen(prod), ' ');			for (i = 0; i < 40; i++)			{				//Seperating the price.				if (priceNis[i  + 1] != 'N')					priceNoNis[i] = priceNis[i + 1];			}			//A calculation of the total price.						total += atoi(priceNoNis) * atoi(qty) * (100.0 - atoi(disc)) / 100.0;		}	}	sprintf(confirm, "Total Price: %.2f NIS", total);	write(0, confirm, strlen(confirm));	write(0, "(Confirm to approve/else Cancel)\n", strlen("(Confirm to approve/else Cancel)\n"));	//An infinite loop that runs until the user input is Confirm or Cancel.	while (1)	{		//Reseting the string in each iteration.		memset(bufferProd, 0, sizeof(bufferProd));		if ((rbytes = read (0, &bufferProd, SIZE)) == -1)			errorMsg("Read");		if (strcmp(bufferProd, "Confirm\n") == 0)		{			write(file, confirm, strlen(confirm));			write(file, "\n", 1);			//Assembling the date string with the help of time.h.			sprintf(date, "%d/%d/%d", tm.tm_mday, tm.tm_mon + 1, tm.tm_year + 1900);			write(file, date, strlen(date));			if((pid = fork()) == 0)			{				//Using chmod command to change the file permissions.				execl("/bin/chmod","chmod","0444", name, NULL);				errorMsg("Error");			}			else if (pid == -1)				errorMsg("Fork failed.");			wait();			break;		}		else if (strcmp(bufferProd, "Cancel\n") == 0)		{			if((pid = fork()) == 0)			{				close(file);				//A flag that signals whether the customer file has been closed before or not. 				flag = 0;				//If the user cancels his order, customer file is removed.				execl("/bin/rm", "rm",  name, NULL);				errorMsg("Error");			}			else if (pid == -1)				errorMsg("Fork failed.");			wait();			break;		}			write(0, "Invalid input, (Confirm to approve/else Cancel)\n", strlen("Invalid input, (Confirm to approve/else Cancel)\n"));		}	printf("Order created! // %s.txt created in %s_Order dir with Read Mode\n", argv[2], argv[1]);	if (flag)		close(file);	close(storeFilePtr);	return 0;}/*This function will be called in case there's an error and the program needs to be terminated.*/void errorMsg(char* str){	perror(str);	exit(1);}